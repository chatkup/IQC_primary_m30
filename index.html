<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบแสดงผลการควบคุมคุณภาพภายใน (IQC) - เครือข่ายบริการสุขภาพอำเภอม่วงสามสิบ</title>

    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <!-- Thai Font -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Prompt', sans-serif;
            margin: 0;
            padding: 0;
        }

        .icon {
            width: 1em;
            height: 1em;
            display: inline-block;
            vertical-align: middle;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        @media (max-width: 768px) {
            .responsive-container {
                padding: 0.5rem !important;
            }

            .responsive-grid {
                grid-template-columns: 1fr !important;
            }

            .responsive-flex {
                flex-direction: column !important;
            }

            .responsive-text {
                font-size: 0.875rem !important;
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        .transition-all {
            transition: all 0.3s ease;
        }

        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="root">
        <div class="flex items-center justify-center h-screen bg-gray-50">
            <div class="text-center">
                <div
                    class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4">
                </div>
                <p class="text-gray-600">กำลังโหลดระบบ IQC...</p>
            </div>
        </div>
    </div>
    
    <script>
        // Simple Icons as SVG strings
        const RefreshIcon = `<svg class="icon" viewBox="0 0 24 24"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>`;

        const DownloadIcon = `<svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`;

        const ExternalIcon = `<svg class="icon" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15,3 21,3 21,9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>`;

        // Application State
        let selectedStation = '';
        let selectedFiscalYear = 'all';
        let selectedMeanSDMode = 'custom'; // เปลี่ยนเป็น custom เป็น default
        let customMeanSD = { // ค่า Mean/SD ที่โหลดจาก Google Sheets
            level1: { mean: 50, sd: 5 },
            level2: { mean: 100, sd: 10 },
            level3: { mean: 200, sd: 20 }
        };
        let processedData = null;
        let loading = true;
        let lastUpdate = null;
        let autoRefresh = true;
        let error = null;
        let charts = {};
        let showGlucoseTable = false;

        // Proxy Server URL
        const API_BASE_URL = 'https://iqc-proxy-server.onrender.com';

// สำหรับ development (comment ไว้)
// const API_BASE_URL = 'http://localhost:10000';


    // ฟังก์ชันสำหรับโหลด Config
    async function loadConfig() {
    try {
    console.log('Loading config from proxy server...');
    const response = await fetch(`${API_BASE_URL}/api/config`, {
    method: 'GET',
    mode: 'cors'
    });

    if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
    }

    const result = await response.json();
    console.log('Config loaded:', result);

    if (result.success && result.config) {
    customMeanSD = result.config;
    console.log('Config updated from server:', customMeanSD);
    } else {
    console.log('Using default config');
    }

    return result.success;
    } catch (error) {
    console.error('Error loading config:', error);
    return false;
    }
    }


    // Empty data structure
    const mockData = {
    stations: [],
    glucoseData: [],
    pregnancyData: [],
    urineData: []
    };

    // ฟังก์ชันสำหรับคำนวดปีงบประมาณ
    function getBuddhistFiscalYear(date) {
    if (!date || isNaN(date.getTime())) return null;

    const year = date.getFullYear();
    const month = date.getMonth() + 1;

    if (month >= 10) {
    return year + 544;
    } else {
    return year + 543;
    }
    }

    // ฟังก์ชันสำหรับสร้างรายการปีงบประมาณ
    function getFiscalYearOptions() {
    if (!processedData || !processedData.glucoseData.length) return [];

    const fiscalYears = new Set();
    processedData.glucoseData.forEach(item => {
    const date = parseThaiDate(item.testDate);
    const fiscalYear = getBuddhistFiscalYear(date);
    if (fiscalYear) {
    fiscalYears.add(fiscalYear);
    }
    });

    return Array.from(fiscalYears).sort((a, b) => b - a);
    }

    // ฟังก์ชันสำหรับกรองข้อมูลตามปีงบประมาณ
    function filterDataByFiscalYear(data, fiscalYear) {
    if (fiscalYear === 'all') return data;

    return data.filter(item => {
    const date = parseThaiDate(item.testDate);
    const itemFiscalYear = getBuddhistFiscalYear(date);
    return itemFiscalYear === parseInt(fiscalYear);
    });
    }

    // Fetch Data Function
    async function fetchData(showLoading = true) {
    if (showLoading) setLoading(true);
    setError(null);

    try {
    console.log('กำลังดึงข้อมูลจาก proxy server:', `${API_BASE_URL}/api/iqc`);

    const response = await fetch(`${API_BASE_URL}/api/iqc?action=api`, {
    method: 'GET',
    mode: 'cors'
    });

    if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
    }

    const result = await response.json();
    console.log('API Response:', result);

    if (result.success) {
    console.log('API data received successfully');
    setProcessedData(result.data);
    setLastUpdate(new Date(result.lastUpdate));

    if (result.data.stations.length > 0 && !selectedStation) {
    setSelectedStation(result.data.stations[0]);
    }
    } else {
    throw new Error(result.error || 'ไม่สามารถดึงข้อมูลได้');
    }

    } catch (err) {
    console.error('Error fetching data:', err);
    console.log('No data available - API connection failed');
    setError('ไม่สามารถเชื่อมต่อ API ได้ กรุณาตรวจสอบการเชื่อมต่อ');

    setProcessedData(mockData);
    setLastUpdate(new Date());
    } finally {
    setLoading(false);
    }
    }

    // Helper Functions
    function setLoading(value) {
    loading = value;
    render();
    }

    function setError(value) {
    error = value;
    render();
    }

    function setProcessedData(data) {
    processedData = data;
    if (data && data.stations && data.stations.length > 0) {
    if (!selectedStation || (!data.stations.includes(selectedStation) && selectedStation !== 'all')) {
    selectedStation = data.stations[0];
    console.log('Auto-selected station:', selectedStation);
    }
    }
    render();
    }

    function setLastUpdate(date) {
    lastUpdate = date;
    render();
    }

    function setSelectedStation(station) {
    selectedStation = station;
    console.log('Selected station changed to:', station);
    updateCharts();
    render();
    }

    function setSelectedFiscalYear(year) {
    selectedFiscalYear = year;
    console.log('Selected fiscal year changed to:', year);
    updateCharts();
    render();
    }

    function setSelectedMeanSDMode(mode) {
    selectedMeanSDMode = mode;
    console.log('Selected Mean/SD mode changed to:', mode);
    updateCharts();
    render();
    }

    function setAutoRefresh(value) {
    autoRefresh = value;
    render();
    }

    function toggleGlucoseTable() {
    showGlucoseTable = !showGlucoseTable;
    render();
    }

    // Helper function to parse Thai date format
    function parseThaiDate(dateStr) {
    if (!dateStr) return new Date(0);

    if (typeof dateStr === 'number') {
    const excelEpoch = new Date(1900, 0, 1);
    const date = new Date(excelEpoch.getTime() + (dateStr - 1) * 86400 * 1000);

    const bangkokOffset = 7 * 60;
    const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
    return new Date(utc + (bangkokOffset * 60000));
    }

    if (typeof dateStr === 'string') {
    const parts = dateStr.split('/');
    if (parts.length === 3) {
    const day = parseInt(parts[0]);
    const month = parseInt(parts[1]) - 1;
    const year = parseInt(parts[2]);

    const christianYear = year > 2500 ? year - 543 : year;

    const date = new Date(christianYear, month, day);
    return date;
    }

    if (dateStr.includes('T') || dateStr.includes('Z')) {
    const date = new Date(dateStr);
    const bangkokOffset = 7 * 60;
    const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
    return new Date(utc + (bangkokOffset * 60000));
    }
    }

    const date = new Date(dateStr);
    const bangkokOffset = 7 * 60;
    const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
    return new Date(utc + (bangkokOffset * 60000));
    }

    // Helper function to format date in Thai format
    function formatThaiDate(date) {
    if (!date || isNaN(date.getTime())) return '-';

    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = (date.getFullYear() + 543);

    return `${day}/${month}/${year}`;
    }

    // Helper function to format datetime in Thai format
    function formatThaiDateTime(date) {
    if (!date || isNaN(date.getTime())) return '-';

    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = (date.getFullYear() + 543);
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');

    return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    // Chart Functions
    function getChartData(level) {
    if (!processedData) {
    console.log('No data available');
    return [];
    }

    console.log('Getting chart data for station:', selectedStation, 'level:', level);

    // กรองข้อมูลตามปีงบประมาณ
    const filteredByYear = filterDataByFiscalYear(processedData.glucoseData, selectedFiscalYear);

    let stationData;
    if (selectedStation === 'all') {
    // แสดงข้อมูลทุกสถานี
    stationData = filteredByYear;
    } else {
    // แสดงเฉพาะสถานีที่เลือก
    stationData = filteredByYear.filter(item => {
    console.log('Checking item:', item.station, 'vs selected:', selectedStation);
    return item.station === selectedStation;
    });
    }

    const sortedData = stationData.sort((a, b) => {
    // Sort by test date
    const dateA = parseThaiDate(a.testDate);
    const dateB = parseThaiDate(b.testDate);
    return dateA - dateB;
    });

    console.log('Filtered and sorted station data:', sortedData.length, 'items');

    const chartData = sortedData.map((item, index) => {
    const testDate = parseThaiDate(item.testDate);
    return {
    index: index + 1,
    date: formatThaiDate(testDate),
    value: item[level],
    lot: item.lot,
    brand: item.brand,
    tester: item.tester,
    station: item.station,
    sortDate: testDate
    };
    });

    console.log('Final chart data for', level, ':', chartData);
    return chartData;
    }

    // ฟังก์ชันสำหรับข้อมูลทุกสถานี
    function getAllStationsChartData(level) {
    if (!processedData) return [];

    const filteredByYear = filterDataByFiscalYear(processedData.glucoseData, selectedFiscalYear);

    const allStationData = filteredByYear
    .sort((a, b) => {
    const dateA = parseThaiDate(a.testDate);
    const dateB = parseThaiDate(b.testDate);
    return dateA - dateB;
    });

    const chartData = allStationData.map((item, index) => {
    const testDate = parseThaiDate(item.testDate);
    return {
    value: item[level],
    station: item.station,
    date: formatThaiDate(testDate),
    lot: item.lot,
    brand: item.brand,
    tester: item.tester
    };
    });

    return chartData;
    }

    function getStatistics(level) {
    let values = [];

    switch (selectedMeanSDMode) {
    case 'station':
    // โหมด 2: ใช้เฉพาะสถานีที่เลือก
    const stationData = getChartData(level);
    if (stationData.length === 0) return null;
    values = stationData.map(d => d.value).filter(v => v !== null && !isNaN(v));
    break;

    case 'all':
    // โหมด 3: ใช้ข้อมูลทุกสถานี
    const allData = getAllStationsChartData(level);
    if (allData.length === 0) return null;
    values = allData.map(d => d.value).filter(v => v !== null && !isNaN(v));
    break;

    case 'custom':
    // โหมด 1: ใช้ค่าจาก Google Sheets (กำหนดเอง)
    const customData = customMeanSD[level];
    if (!customData) return null;
    return {
    mean: customData.mean.toFixed(1),
    sd: customData.sd.toFixed(1),
    cv: ((customData.sd / customData.mean) * 100).toFixed(1),
    plus2sd: (customData.mean + 2 * customData.sd).toFixed(1),
    minus2sd: (customData.mean - 2 * customData.sd).toFixed(1),
    plus3sd: (customData.mean + 3 * customData.sd).toFixed(1),
    minus3sd: (customData.mean - 3 * customData.sd).toFixed(1)
    };
    }

    if (values.length === 0) return null;

    const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
    const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
    const sd = Math.sqrt(variance);

    return {
    mean: mean.toFixed(1),
    sd: sd.toFixed(1),
    cv: ((sd / mean) * 100).toFixed(1),
    plus2sd: (mean + 2 * sd).toFixed(1),
    minus2sd: (mean - 2 * sd).toFixed(1),
    plus3sd: (mean + 3 * sd).toFixed(1),
    minus3sd: (mean - 3 * sd).toFixed(1)
    };
    }

    // ฟังก์ชันสำหรับกำหนดสีของจุดข้อมูล
    function getPointColors(chartData, statistics) {
    if (!statistics) return chartData.map(() => '#1f2937');

    const mean = parseFloat(statistics.mean);
    const plus2sd = parseFloat(statistics.plus2sd);
    const minus2sd = parseFloat(statistics.minus2sd);
    const plus3sd = parseFloat(statistics.plus3sd);
    const minus3sd = parseFloat(statistics.minus3sd);

    return chartData.map(point => {
    const value = point.value;
    
    // ตรวจสอบช่วงค่าและกำหนดสี
    if (value > plus3sd || value < minus3sd) {
        return '#dc2626'; // สีแดงสำหรับ ±3SD
    } else if (value > plus2sd || value < minus2sd) {
        return '#f97316'; // สีส้มสำหรับ ±2SD
    } else {
        return '#1f2937'; // สีดำปกติ
    }
    });
    }

    // ฟังก์ชันสำหรับกำหนดสีและสถานะของแต่ละแถวในตาราง
    function getRowColorAndStatus(value, statistics) {
    if (!statistics || value === null || value === undefined) {
    return { color: '', bgColor: '', status: '-' };
    }

    const mean = parseFloat(statistics.mean);
    const plus2sd = parseFloat(statistics.plus2sd);
    const minus2sd = parseFloat(statistics.minus2sd);
    const plus3sd = parseFloat(statistics.plus3sd);
    const minus3sd = parseFloat(statistics.minus3sd);

    if (value > plus3sd || value < minus3sd) {
    return { 
        color: 'text-red-800', 
        bgColor: 'bg-red-100', 
        status: '⚠️ นอกช่วง ±3SD' 
    };
    } else if (value > plus2sd || value < minus2sd) {
    return { 
        color: 'text-orange-800', 
        bgColor: 'bg-orange-100', 
        status: '⚠️ นอกช่วง ±2SD' 
    };
    } else {
    return { 
        color: 'text-gray-800', 
        bgColor: 'bg-white', 
        status: '✓ ปกติ' 
    };
    }
    }

    function updateCharts() {
    const levels = ['level1', 'level2', 'level3'];
    const levelNames = {
    'level1': 'Level 1 (Low)',
    'level2': 'Level 2 (Normal)',
    'level3': 'Level 3 (High)'
    };

    levels.forEach(level => {
    const chartData = getChartData(level);
    const statistics = getStatistics(level);

    console.log('Updating chart for level:', level, 'with data:', chartData.length, 'points');

    if (!chartData.length) {
    console.log('No chart data available for level:', level);
    return;
    }

    const ctx = document.getElementById(`leveyChart_${level}`);
    if (!ctx) {
    console.log('Chart canvas not found for level:', level);
    return;
    }

    // Destroy existing chart
    if (charts[level]) {
    charts[level].destroy();
    charts[level] = null;
    }

    try {
    // กำหนดสีของจุดข้อมูลตามช่วงค่า
    const pointColors = getPointColors(chartData, statistics);
    
    // Create new chart
    charts[level] = new Chart(ctx, {
    type: 'line',
    data: {
    labels: chartData.map(d => d.index),
    datasets: [{
    label: 'ค่าผลตรวจ',
    data: chartData.map(d => d.value),
    borderColor: '#1f2937',
    backgroundColor: pointColors, // ใช้สีที่แตกต่างกันสำหรับแต่ละจุด
    pointBackgroundColor: pointColors, // ใช้สีที่แตกต่างกันสำหรับแต่ละจุด
    pointBorderColor: pointColors, // ใช้สีที่แตกต่างกันสำหรับแต่ละจุด
    pointRadius: 4,
    pointHoverRadius: 6,
    borderWidth: 2,
    showLine: true // แสดงเส้นเชื่อมจุด
    }].concat(statistics ? [
    {
    label: 'Mean',
    data: new Array(chartData.length).fill(parseFloat(statistics.mean)),
    borderColor: '#2563eb',
    borderDash: [5, 5],
    pointRadius: 0,
    borderWidth: 2
    },
    {
    label: '+2SD',
    data: new Array(chartData.length).fill(parseFloat(statistics.plus2sd)),
    borderColor: '#16a34a',
    borderDash: [3, 3],
    pointRadius: 0,
    borderWidth: 2
    },
    {
    label: '-2SD',
    data: new Array(chartData.length).fill(parseFloat(statistics.minus2sd)),
    borderColor: '#16a34a',
    borderDash: [3, 3],
    pointRadius: 0,
    borderWidth: 2
    },
    {
    label: '+3SD',
    data: new Array(chartData.length).fill(parseFloat(statistics.plus3sd)),
    borderColor: '#dc2626',
    borderDash: [2, 2],
    pointRadius: 0,
    borderWidth: 2
    },
    {
    label: '-3SD',
    data: new Array(chartData.length).fill(parseFloat(statistics.minus3sd)),
    borderColor: '#dc2626',
    borderDash: [2, 2],
    pointRadius: 0,
    borderWidth: 2
    }
    ] : [])
    },
    options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
    title: {
    display: true,
    text: levelNames[level],
    font: {
    size: 16,
    weight: 'bold'
    }
    },
    tooltip: {
    callbacks: {
    afterLabel: function(context) {
    if (context.datasetIndex === 0) {
    const dataPoint = chartData[context.dataIndex];
    const value = dataPoint.value;
    
    // แสดงสถานะของจุดข้อมูล
    let status = 'ปกติ (อยู่ในช่วง ±2SD)';
    if (statistics) {
    const plus3sd = parseFloat(statistics.plus3sd);
    const minus3sd = parseFloat(statistics.minus3sd);
    const plus2sd = parseFloat(statistics.plus2sd);
    const minus2sd = parseFloat(statistics.minus2sd);
    
    if (value > plus3sd || value < minus3sd) {
        status = '⚠️ อยู่นอกช่วง ±3SD (สีแดง)';
    } else if (value > plus2sd || value < minus2sd) {
        status = '⚠️ อยู่นอกช่วง ±2SD (สีส้ม)';
    }
    }
    
    const labels = [
    `วันที่: ${dataPoint.date}`,
    `Lot: ${dataPoint.lot}`,
    `ยี่ห้อ: ${dataPoint.brand}`,
    `ผู้ทดสอบ: ${dataPoint.tester}`,
    `สถานะ: ${status}`
    ];

    // แสดงชื่อสถานีถ้าเลือก "ทุกหน่วยงาน"
    if (selectedStation === 'all' && dataPoint.station) {
    labels.unshift(`หน่วยงาน: ${dataPoint.station}`);
    }

    return labels;
    }
    return '';
    }
    }
    },
    legend: {
    display: true,
    labels: {
    filter: function(legendItem, chartData) {
    // เพิ่ม legend สำหรับสีของจุด
    return true;
    }
    }
    }
    },
    scales: {
    x: {
    title: {
    display: true,
    text: 'ลำดับการทดสอบ'
    }
    },
    y: {
    title: {
    display: true,
    text: 'ค่าผลตรวจ (mg/dL)'
    }
    }
    }
    }
    });

    console.log('Chart created successfully for level:', level);

    } catch (error) {
    console.error('Error creating chart for level:', level, error);
    }
    });
    }

    // Export Functions
    function exportData() {
    const levels = ['level1', 'level2', 'level3'];
    let csvContent = '';

    levels.forEach(level => {
    const chartData = getChartData(level);
    if (chartData.length > 0) {
    csvContent += `\n${level.toUpperCase()}\n`;
    csvContent += 'ลำดับ,วันที่,ค่าผลตรวจ,Lot,ยี่ห้อ,ผู้ทดสอบ\n';
    chartData.forEach(row => {
    csvContent += `${row.index},${row.date},${row.value},${row.lot},${row.brand},${row.tester}\n`;
    });
    }
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    const fiscalYearSuffix = selectedFiscalYear === 'all' ? 'all' : selectedFiscalYear;
    link.download = `IQC_${selectedStation}_FY${fiscalYearSuffix}_${selectedMeanSDMode}_${new
    Date().toISOString().split('T')[0]}.csv`;
    link.click();
    }

    // Render Function
    function render() {
    const root = document.getElementById('root');

    if (loading && !processedData) {
    root.innerHTML = `
    <div class="flex items-center justify-center h-screen bg-gray-50">
        <div class="flex items-center space-x-2">
            <div class="w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <div class="text-lg">กำลังโหลดข้อมูล...</div>
        </div>
    </div>
    `;
    return;
    }

    const fiscalYearOptions = getFiscalYearOptions();

    root.innerHTML = `
    <div class="space-y-6 p-6 bg-gray-50 min-h-screen responsive-container">
        <!-- Header -->
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2 responsive-text">
                ระบบแสดงผลการควบคุมคุณภาพภายใน (IQC)
            </h1>
            <p class="text-gray-600">เครือข่ายบริการสุขภาพอำเภอม่วงสามสิบ</p>

            <!-- Status Bar -->
            <div
                class="flex justify-center items-center space-x-4 mt-4 p-2 bg-white rounded-lg shadow-sm responsive-flex">
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 rounded-full ${error ? 'bg-yellow-500' : 'bg-green-500'}"></div>
                    <span class="text-sm">
                        ${error ? 'ใช้ข้อมูลจำลอง' : 'เชื่อมต่อปกติ'}
                    </span>
                </div>

                ${lastUpdate ? `
                <div class="text-sm text-gray-600">
                    อัปเดตล่าสุด: ${lastUpdate.toLocaleString('th-TH')}
                </div>
                ` : ''}

                <div class="flex items-center space-x-2">
                    <button onclick="fetchData()" ${loading ? 'disabled' : '' }
                        class="flex items-center px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 transition-all">
                        <span class="w-4 h-4 mr-1 ${loading ? 'animate-spin' : ''}">${RefreshIcon}</span>
                        รีเฟรช
                    </button>

                    <button onclick="setAutoRefresh(!autoRefresh)"
                        class="px-3 py-1 text-sm rounded transition-all ${autoRefresh ? 'bg-blue-600 text-white' : 'border border-gray-300 hover:bg-gray-50'}">
                        ${autoRefresh ? 'หยุด Auto-refresh' : 'เปิด Auto-refresh'}
                    </button>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="space-y-4">
                <!-- Main Controls -->
                <div
                    class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between responsive-flex">
                    <h2 class="text-xl font-semibold text-blue-700">
                        Levey-Jennings Charts: Glucose Strip
                    </h2>
                    <div class="flex gap-2 flex-wrap">
                        <select onchange="setSelectedStation(this.value)"
                            class="px-3 py-2 border border-gray-300 rounded transition-all">
                            <option value="all" ${selectedStation==='all' ? 'selected' : '' }>
                                ทุกหน่วยงาน
                            </option>
                            ${processedData?.stations.map(station =>
                            `<option value="${station}" ${station===selectedStation ? 'selected' : '' }>
                                ${station}
                            </option>`
                            ).join('')}
                        </select>

                        <select onchange="setSelectedFiscalYear(this.value)"
                            class="px-3 py-2 border border-gray-300 rounded transition-all">
                            <option value="all" ${selectedFiscalYear==='all' ? 'selected' : '' }>ทุกปีงบประมาณ</option>
                            ${fiscalYearOptions.map(year =>
                            `<option value="${year}" ${year.toString()===selectedFiscalYear ? 'selected' : '' }>
                                ปีงบประมาณ ${year}
                            </option>`
                            ).join('')}
                        </select>

                        <button onclick="exportData()"
                            class="flex items-center px-3 py-2 border border-gray-300 rounded hover:bg-gray-50 transition-all">
                            <span class="w-4 h-4 mr-1">${DownloadIcon}</span>
                            ส่งออก CSV
                        </button>

                        <button onclick="toggleGlucoseTable()"
                            class="flex items-center px-3 py-2 border border-gray-300 rounded hover:bg-gray-50 transition-all ${showGlucoseTable ? 'bg-blue-100 border-blue-300' : ''}">
                            <span class="w-4 h-4 mr-1">
                                <svg class="icon" viewBox="0 0 24 24">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="9" y1="3" x2="9" y2="21"/>
                                    <line x1="15" y1="3" x2="15" y2="21"/>
                                    <line x1="3" y1="9" x2="21" y2="9"/>
                                    <line x1="3" y1="15" x2="21" y2="15"/>
                                </svg>
                            </span>
                            ${showGlucoseTable ? 'ซ่อนตาราง' : 'แสดงตาราง'}
                        </button>
                    </div>
                </div>

                <!-- Mean/SD Mode Selection -->
                <div class="border-t pt-4">
                    <div class="flex flex-col gap-4">
                        <h3 class="text-lg font-semibold text-gray-700">การคำนวด Mean และ SD:</h3>

                        <!-- Radio Button Options -->
                        <div class="flex flex-col sm:flex-row gap-4">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="radio" name="meanSDMode" value="custom" ${selectedMeanSDMode==='custom'
                                    ? 'checked' : '' } onchange="setSelectedMeanSDMode(this.value)"
                                    class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <span class="text-sm font-medium text-gray-700">กำหนดเอง</span>
                            </label>

                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="radio" name="meanSDMode" value="station" ${selectedMeanSDMode==='station'
                                    ? 'checked' : '' } onchange="setSelectedMeanSDMode(this.value)"
                                    class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <span class="text-sm font-medium text-gray-700">ใช้เฉพาะหน่วยงานที่เลือก</span>
                            </label>

                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="radio" name="meanSDMode" value="all" ${selectedMeanSDMode==='all'
                                    ? 'checked' : '' } onchange="setSelectedMeanSDMode(this.value)"
                                    class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <span class="text-sm font-medium text-gray-700">ใช้ข้อมูลทุกหน่วยงานรวมกัน</span>
                            </label>
                        </div>

                        <!-- แสดงข้อมูล Mean/SD ที่ใช้งาน (เฉพาะโหมดกำหนดเอง) -->
                        ${selectedMeanSDMode === 'custom' ? `
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-700 mb-3">ค่า Mean และ SD ที่กำหนดไว้:</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <div class="bg-white p-3 rounded border">
                                    <h5 class="font-medium text-gray-600 mb-2">Level 1 (Low)</h5>
                                    <div class="space-y-1">
                                        <div>Mean: <span class="font-mono">${customMeanSD.level1.mean}</span></div>
                                        <div>SD: <span class="font-mono">${customMeanSD.level1.sd}</span></div>
                                    </div>
                                </div>
                                <div class="bg-white p-3 rounded border">
                                    <h5 class="font-medium text-gray-600 mb-2">Level 2 (Normal)</h5>
                                    <div class="space-y-1">
                                        <div>Mean: <span class="font-mono">${customMeanSD.level2.mean}</span></div>
                                        <div>SD: <span class="font-mono">${customMeanSD.level2.sd}</span></div>
                                    </div>
                                </div>
                                <div class="bg-white p-3 rounded border">
                                    <h5 class="font-medium text-gray-600 mb-2">Level 3 (High)</h5>
                                    <div class="space-y-1">
                                        <div>Mean: <span class="font-mono">${customMeanSD.level3.mean}</span></div>
                                        <div>SD: <span class="font-mono">${customMeanSD.level3.sd}</span></div>
                                    </div>
                                </div>
                            </div>
                            <p class="text-xs text-blue-600 mt-2">
                                * ค่าเหล่านี้โหลดจาก Google Sheets (Config_MeanSD) และสามารถแก้ไขได้โดยการแก้ไขใน Google
                                Sheets โดยตรง
                            </p>
                        </div>
                        ` : ''}

                        <!-- แสดงคำอธิบายสีจุดข้อมูล -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-700 mb-3">ความหมายสีของจุดข้อมูลบนกราฟ:</h4>
                            <div class="flex flex-wrap gap-4 text-sm">
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 bg-gray-800 rounded-full"></div>
                                    <span>สีดำ: อยู่ในช่วงปกติ (±2SD)</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 bg-orange-500 rounded-full"></div>
                                    <span>สีส้ม: อยู่นอกช่วง ±2SD</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 bg-red-600 rounded-full"></div>
                                    <span>สีแดง: อยู่นอกช่วง ±3SD</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Glucose Data Table (แสดงเมื่อ showGlucoseTable = true) -->
        ${showGlucoseTable && processedData ? `
        <div class="bg-white rounded-lg shadow">
            <div class="p-6">
                <h2 class="text-xl font-semibold text-blue-700 mb-4">
                    ตารางข้อมูล Glucose Strip
                </h2>
                <div class="overflow-x-auto">
                    ${['level1', 'level2', 'level3'].map(level => {
                        const levelNames = {
                            'level1': 'Level 1 (Low)',
                            'level2': 'Level 2 (Normal)', 
                            'level3': 'Level 3 (High)'
                        };
                        const chartData = getChartData(level);
                        const statistics = getStatistics(level);
                        
                        if (chartData.length === 0) return '';
                        
                        return `
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-blue-600 mb-3">${levelNames[level]}</h3>
                            ${statistics ? `
                            <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                                <div class="grid grid-cols-2 md:grid-cols-6 gap-2 text-sm">
                                    <div class="text-center">
                                        <div class="font-semibold text-blue-700">Mean</div>
                                        <div>${statistics.mean}</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="font-semibold text-blue-700">SD</div>
                                        <div>${statistics.sd}</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="font-semibold text-green-700">±2SD</div>
                                        <div>${statistics.minus2sd} - ${statistics.plus2sd}</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="font-semibold text-red-700">±3SD</div>
                                        <div>${statistics.minus3sd} - ${statistics.plus3sd}</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="font-semibold text-blue-700">CV%</div>
                                        <div>${statistics.cv}</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="font-semibold text-blue-700">จำนวน</div>
                                        <div>${chartData.length}</div>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            <table class="w-full border-collapse border border-gray-300 mb-6">
                                <thead>
                                    <tr class="bg-blue-100">
                                        <th class="border border-gray-300 p-2">ลำดับ</th>
                                        <th class="border border-gray-300 p-2">วันที่ทดสอบ</th>
                                        <th class="border border-gray-300 p-2">ค่าผลตรวจ (mg/dL)</th>
                                        <th class="border border-gray-300 p-2">สถานะ</th>
                                        <th class="border border-gray-300 p-2">หน่วยงาน</th>
                                        <th class="border border-gray-300 p-2">ยี่ห้อ</th>
                                        <th class="border border-gray-300 p-2">Lot</th>
                                        <th class="border border-gray-300 p-2">ผู้ทดสอบ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${chartData.map((item, index) => {
                                        const colorStatus = getRowColorAndStatus(item.value, statistics);
                                        return `
                                        <tr class="hover:bg-gray-50 ${colorStatus.bgColor}">
                                            <td class="border border-gray-300 p-2 text-center font-medium">${item.index}</td>
                                            <td class="border border-gray-300 p-2 text-center">${item.date}</td>
                                            <td class="border border-gray-300 p-2 text-center font-bold ${colorStatus.color}">
                                                ${item.value !== null && item.value !== undefined ? item.value.toFixed(1) : '-'}
                                            </td>
                                            <td class="border border-gray-300 p-2 text-center">
                                                <span class="px-2 py-1 rounded text-xs font-medium ${colorStatus.color === 'text-red-800' ? 'bg-red-200 text-red-800' : 
                                                    colorStatus.color === 'text-orange-800' ? 'bg-orange-200 text-orange-800' : 
                                                    'bg-gray-200 text-gray-800'}">
                                                    ${colorStatus.status}
                                                </span>
                                            </td>
                                            <td class="border border-gray-300 p-2 text-center">${item.station}</td>
                                            <td class="border border-gray-300 p-2 text-center">${item.brand}</td>
                                            <td class="border border-gray-300 p-2 text-center">${item.lot}</td>
                                            <td class="border border-gray-300 p-2 text-center">${item.tester}</td>
                                        </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
        ` : ''}

        <!-- Levey-Jennings Charts Vertical -->
        <div class="space-y-6">
            ${['level1', 'level2', 'level3'].map(level => {
            const levelNames = {
            'level1': 'Level 1 (Low)',
            'level2': 'Level 2 (Normal)',
            'level3': 'Level 3 (High)'
            };
            const statistics = getStatistics(level);
            const chartData = getChartData(level);

            return `
            <div class="bg-white rounded-lg shadow">
                <div class="p-6">
                    <h3 class="text-lg font-semibold text-blue-700 mb-4 text-center">
                        ${levelNames[level]}
                    </h3>

                    ${chartData.length > 0 ? `
                    <div class="space-y-4">
                        ${statistics ? `
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 p-3 bg-blue-50 rounded-lg text-sm">
                            <div class="text-center">
                                <div class="font-semibold text-blue-700">Mean</div>
                                <div>${statistics.mean}</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-blue-700">SD</div>
                                <div>${statistics.sd}</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-blue-700">CV%</div>
                                <div>${statistics.cv}</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-blue-700">Points</div>
                                <div>${chartData.length}</div>
                            </div>
                        </div>
                        ` : ''}

                        <div class="chart-container">
                            <canvas id="leveyChart_${level}"></canvas>
                        </div>
                    </div>
                    ` : `
                    <div class="text-center py-8 text-gray-500 text-sm">
                        ไม่พบข้อมูลสำหรับสถานีอนามัยที่เลือก
                    </div>
                    `}
                </div>
            </div>
            `;
            }).join('')}
        </div>

        <!-- Pregnancy Test Table -->
        ${processedData ? `
        <div class="bg-white rounded-lg shadow">
            <div class="p-6">
                <h2 class="text-xl font-semibold text-purple-700 mb-4">
                    ตารางการควบคุมคุณภาพ: Pregnancy Test
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-purple-100">
                                <th class="border border-gray-300 p-2">สถานีอนามัย</th>
                                <th class="border border-gray-300 p-2">วันที่ทดสอบ</th>
                                <th class="border border-gray-300 p-2">ยี่ห้อ</th>
                                <th class="border border-gray-300 p-2">Lot No.</th>
                                <th class="border border-gray-300 p-2">Level 1 (Expected: Negative)</th>
                                <th class="border border-gray-300 p-2">Level 2 (Expected: Positive)</th>
                                <th class="border border-gray-300 p-2">ผลการควบคุม</th>
                                <th class="border border-gray-300 p-2">หมายเหตุ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filterDataByFiscalYear(processedData.pregnancyData, selectedFiscalYear)
                            .filter(item => selectedStation === 'all' || item.station === selectedStation)
                            .sort((a, b) => parseThaiDate(a.testDate) - parseThaiDate(b.testDate))
                            .map((item, index) => {
                            const level1OK = item.level1 === 'Negative';
                            const level2OK = item.level2 === 'Positive';
                            const allOK = level1OK && level2OK;

                            return `
                            <tr class="hover:bg-gray-50">
                                <td class="border border-gray-300 p-2 font-medium">${item.station}</td>
                                <td class="border border-gray-300 p-2">${formatThaiDate(parseThaiDate(item.testDate))}
                                </td>
                                <td class="border border-gray-300 p-2">${item.brand}</td>
                                <td class="border border-gray-300 p-2">${item.lot}</td>
                                <td class="border border-gray-300 p-2 text-center">
                                    <span
                                        class="px-2 py-1 rounded text-sm ${level1OK ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${item.level1}
                                    </span>
                                </td>
                                <td class="border border-gray-300 p-2 text-center">
                                    <span
                                        class="px-2 py-1 rounded text-sm ${level2OK ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${item.level2}
                                    </span>
                                </td>
                                <td class="border border-gray-300 p-2 text-center">
                                    <span
                                        class="px-2 py-1 rounded text-sm font-medium ${allOK ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${allOK ? '✓ ผ่าน' : '✗ ไม่ผ่าน'}
                                    </span>
                                </td>
                                <td class="border border-gray-300 p-2 text-sm">
                                    ${allOK ? 'การควบคุมคุณภาพปกติ' :
                                    (!level1OK && !level2OK) ? 'Level 1 และ 2 ผิดปกติ' :
                                    !level1OK ? 'Level 1 ผิดปกติ' : 'Level 2 ผิดปกติ'}
                                </td>
                            </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Urine Protein Test Table -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6">
                <h2 class="text-xl font-semibold text-blue-700 mb-4">
                    ตารางการควบคุมคุณภาพ: Urine Protein
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-blue-100">
                                <th class="border border-gray-300 p-2">สถานีอนามัย</th>
                                <th class="border border-gray-300 p-2">วันที่ทดสอบ</th>
                                <th class="border border-gray-300 p-2">ยี่ห้อ</th>
                                <th class="border border-gray-300 p-2">Lot No.</th>
                                <th class="border border-gray-300 p-2">วันที่เปิดใช้</th>
                                <th class="border border-gray-300 p-2">Level 1 (Expected: Negative)</th>
                                <th class="border border-gray-300 p-2">Level 2 (Expected: Positive)</th>
                                <th class="border border-gray-300 p-2">ผลการควบคุม</th>
                                <th class="border border-gray-300 p-2">หมายเหตุ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filterDataByFiscalYear(processedData.urineData, selectedFiscalYear)
                            .filter(item => selectedStation === 'all' || item.station === selectedStation)
                            .sort((a, b) => parseThaiDate(a.testDate) - parseThaiDate(b.testDate))
                            .map((item, index) => {
                            const level1OK = item.proteinLevel1 === 'Negative';
                            const level2OK = ['1+', '2+', '3+', '4+'].includes(item.proteinLevel2);
                            const allOK = level1OK && level2OK;

                            return `
                            <tr class="hover:bg-gray-50">
                                <td class="border border-gray-300 p-2 font-medium">${item.station}</td>
                                <td class="border border-gray-300 p-2">${formatThaiDate(parseThaiDate(item.testDate))}
                                </td>
                                <td class="border border-gray-300 p-2">${item.brand}</td>
                                <td class="border border-gray-300 p-2">${item.lot}</td>
                                <td class="border border-gray-300 p-2">${item.openDate ?
                                    formatThaiDate(parseThaiDate(item.openDate)) : '-'}</td>
                                <td class="border border-gray-300 p-2 text-center">
                                    <span
                                        class="px-2 py-1 rounded text-sm ${level1OK ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                                        ${item.proteinLevel1}
                                    </span>
                                </td>
                                <td class="border border-gray-300 p-2 text-center">
                                    <span
                                        class="px-2 py-1 rounded text-sm ${level2OK ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                                        ${item.proteinLevel2}
                                    </span>
                                </td>
                                <td class="border border-gray-300 p-2 text-center">
                                    <span
                                        class="px-2 py-1 rounded text-sm font-medium ${allOK ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                        ${allOK ? '✓ ผ่าน' : '⚠ ต้องตรวจสอบ'}
                                    </span>
                                </td>
                                <td class="border border-gray-300 p-2 text-sm">
                                    ${allOK ? 'การควบคุมคุณภาพปกติ' :
                                    (!level1OK && !level2OK) ? 'Level 1 และ 2 ผิดปกติ' :
                                    !level1OK ? 'Level 1 ควรเป็น Negative' : 'Level 2 ควรเป็น Positive'}
                                </td>
                            </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Urine Sugar Test Table -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6">
                <h2 class="text-xl font-semibold text-orange-700 mb-4">
                    ตารางการควบคุมคุณภาพ: Urine Sugar
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-orange-100">
                                <th class="border border-gray-300 p-2">สถานีอนามัย</th>
                                <th class="border border-gray-300 p-2">วันที่ทดสอบ</th>
                                <th class="border border-gray-300 p-2">ยี่ห้อ</th>
                                <th class="border border-gray-300 p-2">Lot No.</th>
                                <th class="border border-gray-300 p-2">วันที่เปิดใช้</th>
                                <th class="border border-gray-300 p-2">Level 1 (Expected: Negative)</th>
                                <th class="border border-gray-300 p-2">Level 2 (Expected: Positive)</th>
                                <th class="border border-gray-300 p-2">ผลการควบคุม</th>
                                <th class="border border-gray-300 p-2">หมายเหตุ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filterDataByFiscalYear(processedData.urineData, selectedFiscalYear)
                            .filter(item => selectedStation === 'all' || item.station === selectedStation)
                            .sort((a, b) => parseThaiDate(a.testDate) - parseThaiDate(b.testDate))
                            .map((item, index) => {
                            const level1OK = item.sugarLevel1 === 'Negative';
                            const level2OK = ['1+', '2+', '3+', '4+'].includes(item.sugarLevel2);
                            const allOK = level1OK && level2OK;

                            return `
                            <tr class="hover:bg-gray-50">
                                <td class="border border-gray-300 p-2 font-medium">${item.station}</td>
                                <td class="border border-gray-300 p-2">${formatThaiDate(parseThaiDate(item.testDate))}
                                </td>
                                <td class="border border-gray-300 p-2">${item.brand}</td>
                                <td class="border border-gray-300 p-2">${item.lot}</td>
                                <td class="border border-gray-300 p-2">${item.openDate ?
                                    formatThaiDate(parseThaiDate(item.openDate)) : '-'}</td>
                                <td class="border border-gray-300 p-2 text-center">
                                    <span
                                        class="px-2 py-1 rounded text-sm ${level1OK ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                                        ${item.sugarLevel1}
                                    </span>
                                </td>
                                <td class="border border-gray-300 p-2 text-center">
                                    <span
                                        class="px-2 py-1 rounded text-sm ${level2OK ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                                        ${item.sugarLevel2}
                                    </span>
                                </td>
                                <td class="border border-gray-300 p-2 text-center">
                                    <span
                                        class="px-2 py-1 rounded text-sm font-medium ${allOK ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                        ${allOK ? '✓ ผ่าน' : '⚠ ต้องตรวจสอบ'}
                                    </span>
                                </td>
                                <td class="border border-gray-300 p-2 text-sm">
                                    ${allOK ? 'การควบคุมคุณภาพปกติ' :
                                    (!level1OK && !level2OK) ? 'Level 1 และ 2 ผิดปกติ' :
                                    !level1OK ? 'Level 1 ควรเป็น Negative' : 'Level 2 ควรเป็น Positive'}
                                </td>
                            </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        ` : ''}

        <!-- Summary Statistics -->
        ${processedData ? `
        <div class="bg-white rounded-lg shadow">
            <div class="p-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">สรุปสถิติรวม</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 responsive-grid">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-blue-700 mb-2">Glucose Strip</h3>
                        <p class="text-2xl font-bold text-blue-800">${filterDataByFiscalYear(processedData.glucoseData,
                            selectedFiscalYear).filter(item => selectedStation === 'all' || item.station ===
                            selectedStation).length}</p>
                        <p class="text-sm text-blue-600">รายการทดสอบ</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-purple-700 mb-2">Pregnancy Test</h3>
                        <p class="text-2xl font-bold text-purple-800">
                            ${filterDataByFiscalYear(processedData.pregnancyData, selectedFiscalYear).filter(item =>
                            selectedStation === 'all' || item.station === selectedStation).length}</p>
                        <p class="text-sm text-purple-600">รายการทดสอบ</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-green-700 mb-2">Urine Test</h3>
                        <p class="text-2xl font-bold text-green-800">${filterDataByFiscalYear(processedData.urineData,
                            selectedFiscalYear).filter(item => selectedStation === 'all' || item.station ===
                            selectedStation).length}</p>
                        <p class="text-sm text-green-600">รายการทดสอบ</p>
                    </div>
                </div>
            </div>
        </div>
        ` : ''}
    </div>
    `;

    // Update charts after render
    setTimeout(() => {
    updateCharts();
    }, 100);
    }

    // Initialize App
    async function initApp() {
    // Set empty data initially
    setProcessedData(mockData);
    setLoading(true);

    // โหลด config ก่อน
    console.log('Loading configuration...');
    await loadConfig();

    // Start auto-refresh
    if (autoRefresh) {
    setInterval(() => {
    if (autoRefresh) {
    fetchData(false);
    }
    }, 30000);
    }

    // Try to fetch real data from API
    await fetchData(true);
    }

    // Start the app when DOM is ready
    if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initApp);
    } else {
    initApp();
    }
    </script>
</body>


</html>


